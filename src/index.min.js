async function print({browser:e,htmlContents:t,options:r}){const a=await e.newPage();return await a.setContent(t,{waitUntil:"networkidle0"}),a.pdf(r)}async function renderPage({browser:e,url:t}){const r=await e.newPage();return await r.goto(t,{waitUntil:"networkidle0"}),await r.waitFor(500),await r.evaluate(()=>document.documentElement.outerHTML)}function parseRequest(e){const{groups:{filename:t}}=(e.query.filename||"document").match(/^(?<filename>.+?)(?:\.pdf)?$/);return{filename:t,options:{format:"a4",landscape:!1,printBackground:!0,...e.query,path:null}}}const express=require("express"),bodyParser=require("body-parser"),booleanParser=require("express-query-boolean"),numberParser=require("express-query-int"),cors=require("cors"),pdf=require("pdfjs"),tmp=require("tmp"),app=express(),port=3e3,limit=process.env.BODY_LIMIT||"1mb";app.use(express.json({limit:limit})),app.use(bodyParser.text({type:"text/html",limit:limit})),app.use(booleanParser()),app.use(numberParser());export function use(e){function t(){return e.launch({headless:!0,args:["--no-sandbox","--disable-setuid-sandbox"]})}app.post("/",cors(),async(e,r)=>{const a=await t(),{filename:n,options:s}=parseRequest(e),o=await print({htmlContents:e.body,browser:a,options:s});await a.close(),r.attachment(`${n}.pdf`).send(o)}),app.post("/multiple",cors(),async(e,r)=>{const a=await t(),{filename:n,options:s}=parseRequest(e),o=await Promise.all(e.body.pages.map(e=>{const{name:t,removeCallback:r}=tmp.fileSync();return print({htmlContents:e,browser:a,options:{...s,path:t}}).then(()=>({path:t,rm:r}))})),i=o.reduce((e,{path:t,rm:r})=>(e.addPagesOf(new pdf.ExternalDocument(fs.readFileSync(t))),r(),e),new pdf.Document);await a.close();const p=await i.asBuffer();r.attachment(`${n}.pdf`).send(p)}),app.post("/render",cors(),async(e,r)=>{const a=await t(),n=await renderPage({url:e.body.url,browser:a});await a.close(),r.send(n)}),app.options("/*",cors()),app.use((e,t,r,a)=>{r.status(500).send(e.stack)}),app.listen(port,e=>{if(e)return console.error("ERROR: ",e);console.log(`HTML to PDF converter GG listening on port: ${port} v1.0.1`)})}